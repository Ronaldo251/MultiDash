<!-- templates/index.html (Versão COMPLETA com Gráficos 6a e 6b) -->

<!DOCTYPE html>
<html>
<head>
    <title>Visualização Geográfica de Crimes - Ceará</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        :root {
            --sidebar-width: 300px; --sidebar-bg: #2c3e50; --sidebar-text-color: #ecf0f1;
            --sidebar-header-bg: #34495e; --accent-color: #3498db;
        }
        html, body { height: 100%; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        #map { width: 100%; height: 100%; transition: margin-left 0.3s; }
        .sidebar {
            height: 100%; width: var(--sidebar-width ); position: fixed; z-index: 1001; top: 0; left: 0;
            background-color: var(--sidebar-bg); overflow-y: auto; transition: transform 0.3s; padding-top: 20px;
            box-shadow: 3px 0 6px rgba(0,0,0,0.2); transform: translateX(calc(-1 * var(--sidebar-width)));
        }
        .sidebar.open { transform: translateX(0); }
        #map.sidebar-open { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); }
        .open-btn {
            font-size: 24px; cursor: pointer; background-color: white; color: #333; padding: 8px 15px;
            border: none; position: absolute; top: 10px; left: 10px;
            z-index: 1002; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: left 0.3s;
        }
        .open-btn.shifted { left: calc(var(--sidebar-width) + 10px); }
        .accordion {
            background-color: var(--sidebar-header-bg); color: var(--sidebar-text-color); cursor: pointer;
            padding: 15px; width: 100%; border: none; text-align: left; outline: none;
            font-size: 16px; transition: 0.4s; display: block;
        }
        .accordion:hover, .accordion.active { background-color: var(--accent-color); }
        .accordion::after { content: '\\25B6'; font-size: 13px; color: var(--sidebar-text-color); float: right; margin-left: 5px; transition: transform 0.3s; }
        .accordion.active::after { transform: rotate(90deg); }
        .panel { padding: 0 18px; background-color: var(--sidebar-bg); max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .panel label, .panel span { color: var(--sidebar-text-color); display: block; margin-top: 15px; margin-bottom: 5px; }
        .panel select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        .checkbox-list { list-style: none; padding: 0; margin: 10px 0; }
        .checkbox-list li { margin-bottom: 10px; }
        .checkbox-list input { margin-right: 10px; }
        .chart-popup {
            position: absolute; top: 100px; left: 350px; width: 800px; height: 500px;
            background: white; border: 1px solid #ccc; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1005; border-radius: 8px; display: none; resize: both; overflow: auto;
        }
        .chart-popup-header { padding: 10px; cursor: move; background-color: #f1f1f1; color: #333; border-bottom: 1px solid #ddd; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .chart-popup-header .close-btn { float: right; cursor: pointer; font-weight: bold; }
        .chart-popup-content { padding: 15px; height: calc(100% - 45px); }
        .sub-panel { border-left: 3px solid var(--accent-color); margin-left: 10px; padding-left: 10px; margin-top: 10px; }
    </style>
</head>
<body>

    <button class="open-btn" onclick="toggleNav()">&#9776;</button>
    <div id="mySidebar" class="sidebar">
        <h2 style="color: white; text-align: center; margin-bottom: 20px;">Análise Criminal</h2>
        <button class="accordion">Filtros de Mapa</button>
        <div class="panel">
            <label for="crime-select">Selecione o Tipo de Crime:</label>
            <select id="crime-select">
                {% for crime in crimes %}
                    <option value="{{ crime }}">{{ crime }}</option>
                {% endfor %}
            </select>
        </div>
        <button class="accordion">Visualizar Gráficos</button>
        <div class="panel">
            <span><b>Crimes Gerais</b></span>
            <ul class="checkbox-list">
                <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="evolucao_anual" data-chart-title="Evolução Anual de Crimes por Gênero" data-chart-type="line"> Evolução Anual por Gênero</label></li>
                <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="comparativo_crime_log" data-chart-title="Quantidade de Vítimas por Tipo de Crime" data-chart-type="bar"> Quantidade por Tipo de Crime</label></li>
                <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="proporcao_genero_crime" data-chart-title="Proporção de Gênero por Tipo de Crime" data-chart-type="bar" data-chart-stacked="true" data-chart-axis="y"> Proporção de Gênero por Crime</label></li>
                <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="distribuicao_raca" data-chart-title="Distribuição de Vítimas por Raça/Cor" data-chart-type="bar"> Distribuição por Raça/Cor</label></li>
                <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="distribuicao_etaria" data-chart-title="Distribuição de Vítimas por Faixa Etária" data-chart-type="bar"> Distribuição por Faixa Etária</label></li>
                <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="comparativo_idade_genero" data-chart-title="Comparativo de Idade por Gênero" data-chart-type="line"> Comparativo de Idade por Gênero</label></li>
            </ul>
            <hr style="border-color: #444;">
            <span><b>Crimes Contra a Mulher</b></span>
            <ul class="checkbox-list">
                <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="crimes_mulher_dia_hora" data-chart-title="Crimes Contra Mulheres por Dia e Hora" data-chart-type="line"> Crimes por Dia e Hora</label></li>
            </ul>
            <hr style="border-color: #444;">
            <!-- NOVA SEÇÃO PARA GRÁFICOS DE MEIO EMPREGADO -->
            <span><b>Análise por Meio Empregado</b></span>
            <div class="sub-panel">
                <label for="meio-empregado-filter">Filtrar por Gênero:</label>
                <select id="meio-empregado-filter">
                    <option value="todos">Todos os Registros</option>
                    <option value="feminino">Apenas Vítimas Femininas</option>
                </select>
                <ul class="checkbox-list" style="margin-top: 15px;">
                    <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="proporcao_meio_empregado" data-chart-title="Proporção do Meio Empregado" data-chart-type="pie" data-requires-filter="meio-empregado-filter"> Proporção (Pizza)</label></li>
                    <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="evolucao_meio_empregado" data-chart-title="Evolução do Meio Empregado" data-chart-type="line" data-requires-filter="meio-empregado-filter"> Evolução Temporal (Linhas)</label></li>
                </ul>
            </div>
        </div>
    </div>
    <div id="map"></div>
    <div id="chart-popup-template" style="display: none;">
        <div class="chart-popup">
            <div class="chart-popup-header"><span class="title"></span><span class="close-btn">&times;</span></div>
            <div class="chart-popup-content"><canvas></canvas></div>
        </div>
    </div>

    <script>
        // --- LÓGICA DA SIDEBAR (sem alterações) ---
        const sidebar = document.getElementById("mySidebar");
        const mapContainer = document.getElementById("map");
        const openBtn = document.querySelector(".open-btn");
        function toggleNav() {
            sidebar.classList.toggle("open");
            mapContainer.classList.toggle("sidebar-open");
            openBtn.classList.toggle("shifted");
            setTimeout(() => map.invalidateSize(), 300);
        }
        sidebar.classList.add("open");
        mapContainer.classList.add("sidebar-open");
        openBtn.classList.add("shifted");
        const accordions = document.getElementsByClassName("accordion");
        for (let i = 0; i < accordions.length; i++) {
            accordions[i].addEventListener("click", function() {
                this.classList.toggle("active");
                const panel = this.nextElementSibling;
                panel.style.maxHeight = panel.style.maxHeight ? null : panel.scrollHeight + "px";
            });
        }

        // --- LÓGICA DOS GRÁFICOS (ATUALIZADA PARA LIDAR COM FILTROS) ---
        Chart.register(ChartDataLabels);
        const activeCharts = {};
        $('.chart-checkbox').on('change', function() {
            const chartId = $(this).data('chart-id');
            const chartTitle = $(this).data('chart-title');
            const chartType = $(this).data('chart-type') || 'line';
            const isStacked = $(this).data('chart-stacked') || false;
            const mainAxis = $(this).data('chart-axis') || 'x';
            const filterId = $(this).data('requires-filter');

            if (this.checked) {
                createChartPopup(chartId, chartTitle, chartType, isStacked, mainAxis, filterId);
            } else {
                destroyChartPopup(chartId);
            }
        });

        // Adiciona um listener para o novo filtro
        $('#meio-empregado-filter').on('change', function() {
            // Para cada gráfico de "meio empregado" que estiver ativo, atualize-o
            $('input[data-requires-filter="meio-empregado-filter"]:checked').each(function() {
                const chartId = $(this).data('chart-id');
                destroyChartPopup(chartId); // Fecha o antigo
                // Re-marca e dispara o evento para recriar o gráfico com o novo filtro
                $(this).prop('checked', true).trigger('change');
            });
        });

        async function createChartPopup(chartId, chartTitle, chartType, isStacked, mainAxis, filterId) {
            const $popup = $('#chart-popup-template .chart-popup').clone().attr('id', 'popup-' + chartId);
            
            let finalChartTitle = chartTitle;
            let apiUrl = `/api/data/grafico_${chartId}`;

            // Se o gráfico requer um filtro, pega o valor e adiciona à URL e ao título
            if (filterId) {
                const filterValue = $(`#${filterId}`).val();
                apiUrl += `?filtro=${filterValue}`;
                const filterText = $(`#${filterId} option:selected`).text();
                finalChartTitle += ` (${filterText})`;
            }
            
            $popup.find('.title').text(finalChartTitle);
            $('body').append($popup);
            $popup.draggable({ handle: ".chart-popup-header" }).resizable();
            $popup.find('.close-btn').on('click', function() {
                $(`.chart-checkbox[data-chart-id="${chartId}"]`).prop('checked', false);
                destroyChartPopup(chartId);
            });

            try {
                const response = await fetch(apiUrl);
                const chartData = await response.json();
                const ctx = $popup.find('canvas')[0].getContext('2d');
                const chartOptions = {
                    responsive: true, maintainAspectRatio: false, indexAxis: mainAxis,
                    scales: { x: { stacked: isStacked }, y: { stacked: isStacked, beginAtZero: true } },
                    plugins: {
                        legend: { display: chartData.datasets.length > 1 && chartType !== 'pie' },
                        datalabels: {
                            // Para pizza, mostra a porcentagem
                            formatter: (value, ctx) => {
                                if (chartType === 'pie') {
                                    let sum = 0;
                                    let dataArr = ctx.chart.data.datasets[0].data;
                                    dataArr.map(data => { sum += data; });
                                    let percentage = (value*100 / sum).toFixed(1)+"%";
                                    return percentage;
                                }
                                return Math.round(value);
                            },
                            color: '#fff',
                            font: { weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || context.label || '';
                                    if (label) { label += ': '; }
                                    if (isStacked && mainAxis === 'y') { label += parseFloat(context.raw).toFixed(2) + '%'; } 
                                    else { label += context.raw; }
                                    return label;
                                }
                            }
                        }
                    }
                };
                if (chartId === 'comparativo_crime_log') { chartOptions.scales.y.type = 'logarithmic'; }
                if (isStacked && mainAxis === 'y') { chartOptions.scales.x.max = 100; }
                if (!['proporcao_genero_crime'].includes(chartId)) {
                    chartOptions.plugins.datalabels.display = false;
                }

                activeCharts[chartId] = new Chart(ctx, { type: chartType, data: chartData, options: chartOptions });
                $popup.show();
            } catch (error) {
                console.error("Erro ao buscar dados do gráfico:", error);
                $popup.remove();
            }
        }
        function destroyChartPopup(chartId) {
            if (activeCharts[chartId]) { activeCharts[chartId].destroy(); delete activeCharts[chartId]; }
            $('#popup-' + chartId).remove();
        }

        // --- LÓGICA DO MAPA (sem alterações) ---
        try {
            const map = L.map('map', { center: [-5.2, -39.5], zoom: 7, minZoom: 7 });
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>' } ).addTo(map);
            let geojsonLayer;
            function getColor(t,m){const n=Number(t);if(isNaN(n)||n<=0)return'#E5E5E5';if(m===0)return'#ffffb2';const o=['#ffffb2','#fed976','#feb24c','#fd8d3c','#f03b20','#bd0026'];if(n>m*0.8)return o[5];if(n>m*0.6)return o[4];if(n>m*0.4)return o[3];if(n>m*0.2)return o[2];if(n>m*0.05)return o[1];return o[0]}
            function style(f,m){const t=f.properties.TAXA_POR_100K;return{fillColor:getColor(t,m),weight:1,opacity:1,color:'black',fillOpacity:0.8}}
            async function updateMap(c){if(geojsonLayer)map.removeLayer(geojsonLayer);try{const r=await fetch(`/api/map_data/${c}`);const d=await r.json();const g=d.geojson;const m=d.max_taxa;geojsonLayer=L.geoJson(g,{style:(f)=>style(f,m),onEachFeature:function(f,l){const p=f.properties;const n=p.name||"Nome indisponível";const q=Number(p.QUANTIDADE);const t=Number(p.TAXA_POR_100K);const o=`<h4>${n}</h4><b>Nº Absoluto:</b> ${!isNaN(q)?q.toFixed(0):'N/A'}  
<b>Taxa/100k:</b> ${!isNaN(t)?t.toFixed(2):'N/A'}`;l.bindPopup(o)}}).addTo(map)}catch(e){console.error('ERRO DENTRO DO updateMap:',e)}}
            const crimeSelect=document.getElementById('crime-select');crimeSelect.addEventListener('change',(e)=>{updateMap(e.target.value)});
            $('.accordion').click();
            setTimeout(()=>map.invalidateSize(),400);
            updateMap(crimeSelect.value);
        } catch (e) { console.error("ERRO FATAL NA INICIALIZAÇÃO DO SCRIPT:", e); }
    </script>

</body>
</html>
